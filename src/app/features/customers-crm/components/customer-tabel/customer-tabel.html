<div class="container-fluid p-0 m-0">
  <!-- Add PrimeNG ConfirmDialog -->
  <p-confirmDialog
    [style]="{ width: '350px' }"
    acceptLabel="{{ 'COMMON.YES' | translate }}"
    rejectLabel="{{ 'COMMON.NO' | translate }}"
    acceptIcon="pi pi-check red"
    rejectIcon="pi pi-times"
  ></p-confirmDialog>
  <p-dialog
    [header]="'CUSTOMERS-CRM.import-dialog.title' | translate"
    [modal]="true"
    [(visible)]="visible"
    [style]="{ width: '30rem' }"
  >
    <div class="d-flex flex-column gap-3">
      <span class="text-secondary">{{
        'CUSTOMERS-CRM.import-dialog.description' | translate
      }}</span>
      <div class="form-group">
        <label for="fileInput" class="form-label">{{
          'CUSTOMERS-CRM.import-dialog.select-file' | translate
        }}</label>
        <input
          type="file"
          #fileInput
          id="fileInput"
          class="form-control"
          accept=".xlsx,.xls,.csv"
          (change)="onFileSelected($event)"
        />
        <small class="text-muted">{{
          'CUSTOMERS-CRM.import-dialog.file-type-hint' | translate
        }}</small>
      </div>
      @if (selectedFileName()) {
        <div class="alert alert-info py-2">
          <i class="pi pi-file me-2"></i>
          <span>{{ selectedFileName() }}</span>
        </div>
      }
    </div>
    <div class="d-flex justify-content-between gap-2 mt-4 flex-wrap">
      <button
        type="button"
        class="btn btn-outline-primary"
        (click)="downloadTemplate()"
        [disabled]="isImporting() || templateDownloadLoading()"
      >
        @if (!templateDownloadLoading()) {
          <i class="pi pi-download me-2"></i>
        } @else {
          <i class="pi pi-spin pi-spinner me-2"></i>
        }
        {{ 'CUSTOMERS-CRM.import-dialog.download-template' | translate }}
      </button>
      <div class="d-flex gap-2">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeDialog()"
          [disabled]="isImporting()"
        >
          {{ 'COMMON.CANCEL' | translate }}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="importCustomers()"
          [disabled]="!selectedFile() || isImporting()"
        >
          @if (!isImporting()) {
            <span
              ><i class="pi pi-upload me-2"></i
              >{{ 'CUSTOMERS-CRM.import-dialog.import-button' | translate }}</span
            >
          } @else {
            <span
              ><i class="pi pi-spin pi-spinner me-2"></i
              >{{ 'CUSTOMERS-CRM.import-dialog.importing-button' | translate }}</span
            >
          }
        </button>
      </div>
    </div>
  </p-dialog>
  <div class="card border-0 bg-transparent">
    <p-table
      #dt1
      [value]="customersTabelData()"
      dataKey="id"
      [tableStyle]="{ 'min-width': '100%', 'overflow-x': 'auto' }"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [rowsPerPageOptions]="[5, 10, 20, 50]"
      [lazy]="true"
      (onPage)="onPageChange($event)"
      (onSort)="onSortColumn($event)"
      [loading]="loading()"
      responsiveLayout="scroll"
      paginatorDropdownAppendTo="body"
    >
      <ng-template #caption>
        <!-- Responsive Header Container -->
        <div class="responsive-header">
          <!-- Desktop Layout (default) -->
          <div class="d-none d-md-flex w-100 align-items-center">
            <!-- Left Section: Action Buttons -->
            <div class="desktop-action-btns d-flex gap-2">
              <!-- Bulk Delete Button (Manager/Admin only) -->
              @if (canDeleteCustomer()) {
                <button
                  class="btn btn-sm btn-danger text-white px-3 py-2 d-flex justify-content-center align-items-center gap-2"
                  (click)="deleteSelectedCustomers()"
                  [disabled]="bulkDeleteLoading() || selectedCustomersCount === 0"
                  [title]="'CUSTOMERS-CRM.delete-selected' | translate"
                >
                  <i
                    class="pi fs-875"
                    [ngClass]="bulkDeleteLoading() ? 'pi-spinner pi-spin' : 'pi-trash'"
                  ></i>
                  <span>{{ 'CUSTOMERS-CRM.delete' | translate }}</span>
                  <span *ngIf="selectedCustomersCount > 0" class="ms-1">
                    ({{ selectedCustomersCount }})
                  </span>
                </button>
              }

              <!-- Export Button -->
              <button
                class="btn btn-sm primary-bg-clr text-white px-3 py-2 d-flex justify-content-center align-items-center gap-2"
                (click)="exportCustomers()"
                [disabled]="exportLoading() || selectedCustomersCount === 0"
              >
                <i
                  class="pi fs-875"
                  [ngClass]="exportLoading() ? 'pi-spinner pi-spin' : 'pi-download'"
                ></i>
                <span>{{ 'CUSTOMERS-CRM.export' | translate }}</span>
                <span *ngIf="selectedCustomersCount > 0" class="ms-1">
                  ({{ selectedCustomersCount }})
                </span>
              </button>

              <!-- Import Button (Admins/Managers only) -->
              @if (
                currentUser()?.type === userTypes.ADMIN || currentUser()?.type === userTypes.MANAGER
              ) {
                <button
                  class="btn btn-sm btn-outline-primary outline-primary-clr px-3 py-2 d-flex justify-content-center align-items-center gap-2"
                  (click)="showDialog()"
                >
                  <i class="pi pi-upload fs-875"></i>
                  {{ 'COMMON.IMPORT' | translate }}
                </button>
              }

              <!-- Clear Selection Button -->
              <button
                *ngIf="selectedCustomersCount > 0"
                class="btn btn-sm btn-outline-secondary px-3 py-2"
                (click)="clearSelections()"
                [disabled]="exportLoading() || bulkDeleteLoading()"
              >
                {{ 'COMMON.CLEAR' | translate }}
              </button>
            </div>

            <!-- Center Section: Search -->
            <div class="desktop-search flex-grow-1 mx-3">
              <p-iconfield iconPosition="left" class="w-100">
                <p-inputicon>
                  <i class="pi pi-search"></i>
                </p-inputicon>
                <input
                  pInputText
                  type="text"
                  class="w-100"
                  (input)="onSearchChange($any($event.target).value)"
                  #searchInput
                  [placeholder]="'CUSTOMERS-CRM.search' | translate"
                />
              </p-iconfield>
            </div>

            <!-- Right Section: Add Customer -->
            <div class="desktop-add-btn">
              <button
                class="btn btn-primary primary-bg-clr d-flex justify-content-center px-3 py-2 align-items-center gap-2 rounded-3"
                routerLink="/main/customers/add-customer"
              >
                <span>{{ 'CUSTOMERS-CRM.add-customer' | translate }}</span>
              </button>
            </div>
          </div>

          <!-- Mobile Layout -->
          <div class="d-md-none">
            <!-- Search at the top -->
            <div class="mobile-search mb-3">
              <p-iconfield iconPosition="left" class="w-100">
                <p-inputicon>
                  <i class="pi pi-search"></i>
                </p-inputicon>
                <input
                  pInputText
                  type="text"
                  class="w-100"
                  (input)="onSearchChange($any($event.target).value)"
                  #searchInput
                  [placeholder]="'CUSTOMERS-CRM.search' | translate"
                />
              </p-iconfield>
            </div>

            <!-- Action buttons in a single row -->
            <div class="mobile-action-btns d-flex gap-2 mb-3">
              <!-- Delete Button (Icon only) - Manager/Admin only -->
              @if (canDeleteCustomer()) {
                <button
                  class="btn btn-sm btn-danger text-white px-2 py-2 d-flex justify-content-center align-items-center flex-grow-1"
                  (click)="deleteSelectedCustomers()"
                  [disabled]="bulkDeleteLoading() || selectedCustomersCount === 0"
                  [title]="'CUSTOMERS-CRM.delete-selected' | translate"
                >
                  <i
                    class="pi"
                    [ngClass]="bulkDeleteLoading() ? 'pi-spinner pi-spin' : 'pi-trash'"
                  ></i>
                  <span class="ms-1 d-none d-sm-inline">{{
                    'CUSTOMERS-CRM.delete' | translate
                  }}</span>
                  <span *ngIf="selectedCustomersCount > 0" class="ms-1">
                    ({{ selectedCustomersCount }})
                  </span>
                </button>
              }
              <!-- Import Button (Admins/Managers only) -->
              @if (
                currentUser()?.type === userTypes.ADMIN || currentUser()?.type === userTypes.MANAGER
              ) {
                <div class="import-btn-container ms-auto">
                  <button
                    class="btn btn-sm btn-outline-primary outline-primary-clr px-2 py-2 d-flex justify-content-center align-items-center flex-grow-1"
                    (click)="showDialog()"
                  >
                    <i class="pi pi-upload d-sm-none"></i>
                    <span class="d-none d-sm-inline">{{ 'COMMON.IMPORT' | translate }}</span>
                  </button>
                </div>
              }
              <!-- Export Button (Icon + Text) -->
              <button
                class="btn btn-sm primary-bg-clr text-white px-2 py-2 d-flex justify-content-center align-items-center flex-grow-1"
                (click)="exportCustomers()"
                [disabled]="exportLoading() || selectedCustomersCount === 0"
              >
                <i
                  class="pi"
                  [ngClass]="exportLoading() ? 'pi-spinner pi-spin' : 'pi-download'"
                ></i>
                <span class="ms-1 d-none d-sm-inline">{{
                  'CUSTOMERS-CRM.export' | translate
                }}</span>
              </button>

              <!-- Clear Button (Icon only when text doesn't fit) -->
              <button
                *ngIf="selectedCustomersCount > 0"
                class="btn btn-sm btn-outline-secondary px-2 py-2 d-flex justify-content-center align-items-center flex-grow-1"
                (click)="clearSelections()"
                [disabled]="exportLoading() || bulkDeleteLoading()"
              >
                <i class="pi pi-times d-sm-none"></i>
                <span class="d-none d-sm-inline">{{ 'COMMON.CLEAR' | translate }}</span>
              </button>

              <!-- Add Button (Icon + Text) -->
              <button
                class="btn btn-sm btn-primary primary-bg-clr px-2 py-2 d-flex justify-content-center align-items-center flex-grow-1"
                routerLink="/main/customers/add-customer"
              >
                <i class="pi pi-plus d-sm-none"></i>
                <span class="d-none d-sm-inline">{{
                  'CUSTOMERS-CRM.add-customer' | translate
                }}</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Title Section -->
        <div
          class="title-container my-3 my-md-4"
          [attr.dir]="languageService.direction()"
          [ngClass]="{
            'text-center': true,
            'text-md-start': !languageService.isRTL(),
            'text-md-end': languageService.isRTL(),
          }"
        >
          <h5 class="m-0 p-0">{{ 'CUSTOMERS-CRM.all-customers' | translate }}</h5>
          <small class="text-muted" *ngIf="selectedCustomersCount > 0">
            {{ selectedCustomersCount }}
            {{ 'CUSTOMERS-CRM.selected-customers-for-action' | translate }}
          </small>
          <div class="mt-2 d-block d-md-none">
            <small class="text-muted">{{ 'CUSTOMERS-CRM.swipe-to-scroll' | translate }}</small>
          </div>
        </div>
      </ng-template>

      <ng-template #header>
        <tr>
          <th class="text-center" style="width: 60px">
            <div class="d-flex justify-content-center align-items-center">
              <input
                type="checkbox"
                name="select-all"
                id="select-all"
                [checked]="isAllSelected"
                (change)="onSelectAll($event)"
                [title]="'CUSTOMERS-CRM.select-all' | translate"
              />
            </div>
          </th>
          <th class="d-none d-md-table-cell">
            {{ 'CUSTOMERS-CRM.customer-id' | translate }}
          </th>
          <th>
            {{ 'CUSTOMERS-CRM.phone-number' | translate }}
          </th>
          <th [pSortableColumn]="'fullName'">
            <div class="d-flex justify-content-center align-items-center gap-1">
              {{ 'CUSTOMERS-CRM.customer-name' | translate }}
              <p-sortIcon field="fullName" />
            </div>
          </th>
          <th>
            {{ 'CUSTOMERS-CRM.no-of-orders' | translate }}
          </th>
          <th class="d-none d-md-table-cell">
            {{ 'CUSTOMERS-CRM.assigned-to' | translate }}
          </th>
          <th style="width: 150px">
            {{ 'CUSTOMERS-CRM.actions' | translate }}
          </th>
        </tr>
      </ng-template>

      <ng-template #body let-customer let-rowIndex="rowIndex">
        <tr>
          <td class="text-center">
            <input
              type="checkbox"
              name="select-customer"
              id="customer-{{ customer.id }}"
              [checked]="customer.selected"
              (change)="toggleCustomerSelection(customer)"
              [title]="'CUSTOMERS-CRM.select-customer' | translate"
            />
          </td>
          <td class="d-none d-md-table-cell" [title]="customer.id">
            {{ customer.id | slice: 0 : 8 }}{{ customer.id.length > 8 ? '...' : '' }}
          </td>
          <td>{{ customer.phoneNumber }}</td>
          <td>
            <span class="d-none d-md-inline">{{ customer.fullName }}</span>
            <span class="d-md-none"
              >{{ customer.fullName | slice: 0 : 12
              }}{{ customer.fullName.length > 12 ? '...' : '' }}</span
            >
          </td>
          <td>{{ customer.noOrders }}</td>
          <td class="d-none d-md-table-cell">{{ customer.assignedTo }}</td>
          <td class="action-buttons">
            <button
              class="btn btn-sm p-1"
              (click)="viewCustomer(customer.id); $event.stopPropagation()"
              [title]="'COMMON.VIEW' | translate"
            >
              <i class="pi pi-eye"></i>
            </button>
            <button
              class="btn btn-sm p-1"
              (click)="editCustomer(customer.id); $event.stopPropagation()"
              [title]="'COMMON.EDIT' | translate"
            >
              <i class="pi pi-pencil"></i>
            </button>
            @if (canDeleteCustomer()) {
              <button
                class="btn btn-sm p-1"
                (click)="onDeleteCustomer(customer.id); $event.stopPropagation()"
                [title]="'COMMON.DELETE' | translate"
              >
                <i class="pi pi-trash"></i>
              </button>
            }
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="7" class="text-center py-4">
            {{ 'CUSTOMERS-CRM.no-customers-found' | translate }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Customer Details Dialog -->
<app-customer-details
  [customerId]="selectedCustomerForDialog()"
  [(visible)]="showDetailsDialog"
  (onClose)="closeDetailsDialog()"
>
</app-customer-details>
