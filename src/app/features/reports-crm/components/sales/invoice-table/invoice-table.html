<div class="container-fluid p-0 m-0">
  <div class="card border-0 bg-transparent">
    <p-table #dt [value]="invoicesData()" dataKey="id" [tableStyle]="{ 'min-width': '100%', 'overflow-x': 'auto' }"
      [paginator]="true" [rows]="pageSizeControl.value || 10" [totalRecords]="totalRecords()"
      [rowsPerPageOptions]="getResponsiveRowsPerPageOptions()" [lazy]="true" (onPage)="onPageChange($event)"
      [loading]="loading()" responsiveLayout="scroll" paginatorDropdownAppendTo="body">

      <ng-template #caption>
        <!-- Responsive Header Container -->
        <div class="responsive-header">
          <!-- Desktop Layout -->
          <div class="d-none d-md-flex flex-column w-100">
            <!-- First Row: Title and Action Buttons -->
            <div class="desktop-top-row w-100 d-flex align-items-center justify-content-between mb-3">
              <!-- Title -->
              <div class="desktop-title-section">
                <h5 class="m-0 p-0">{{ 'REPORTS.invoices-report' | translate }}</h5>
                <small class="text-muted">{{ 'REPORTS.invoices-summary' | translate }}</small>
              </div>

              <!-- Action Buttons -->
              <div class="desktop-action-btns d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary px-3 py-2 d-flex align-items-center gap-2"
                  (click)="refreshInvoices()" [disabled]="loading()" [title]="'COMMON.REFRESH' | translate">
                  <i class="pi" [ngClass]="loading() ? 'pi-spinner pi-spin' : 'pi-refresh'"></i>
                  <span class="d-none d-lg-inline">{{ 'COMMON.REFRESH' | translate }}</span>
                </button>

                <button class="btn btn-sm primary-bg-clr text-white px-3 py-2 d-flex align-items-center gap-2"
                  (click)="exportInvoices()" [disabled]="exportLoading() || invoicesData().length === 0"
                  [title]="'COMMON.EXPORT' | translate">
                  <i class="pi" [ngClass]="exportLoading() ? 'pi-spinner pi-spin' : 'pi-download'"></i>
                  <span class="d-none d-lg-inline">{{ 'COMMON.EXPORT' | translate }}</span>
                </button>
              </div>
            </div>

            <!-- Second Row: Search and Filters -->
            <div class="desktop-search-filters-row w-100 d-flex align-items-center gap-3">
              <!-- Search - Takes More Space -->
              <div class="desktop-search-container flex-grow-1">
                <p-iconfield iconPosition="left" class="w-100">
                  <p-inputicon>
                    <i class="pi pi-search"></i>
                  </p-inputicon>
                  <input pInputText type="text" class="w-100" [formControl]="searchControl"
                    [placeholder]="'REPORTS.search-invoices' | translate" />
                </p-iconfield>
              </div>

              <!-- Filters -->
              <div class="desktop-filters-container d-flex gap-2 align-items-center">
                <!-- Status Filter -->
                <select class="form-select filter-select" [formControl]="statusControl">
                  <option *ngFor="let option of statusOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>

                <!-- Period Filter -->
                <select class="form-select filter-select" [formControl]="periodControl">
                  <option *ngFor="let option of periodOptions" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>

                <!-- Sales Agent Filter -->
                <select class="form-select filter-select" [formControl]="salesAgentIdControl">
                  <option *ngFor="let option of salesAgentOptions()" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- Mobile Layout (Unchanged) -->
          <div class="d-md-none">
            <!-- Title -->
            <div class="mobile-title mb-2">
              <h6 class="m-0">{{ 'REPORTS.invoices-report' | translate }}</h6>
              <small class="text-muted">{{ 'REPORTS.invoices-summary' | translate }}</small>
            </div>

            <!-- Search -->
            <div class="mobile-search mb-3">
              <p-iconfield iconPosition="left" class="w-100">
                <p-inputicon>
                  <i class="pi pi-search"></i>
                </p-inputicon>
                <input pInputText type="text" class="w-100" [formControl]="searchControl"
                  [placeholder]="'REPORTS.search-invoices' | translate" />
              </p-iconfield>
            </div>

            <!-- Filters -->
            <div class="mobile-filters d-flex flex-column gap-2 mb-3">
              <select class="form-select filter-select-mobile" [formControl]="statusControl">
                <option *ngFor="let option of statusOptions" [value]="option.value">
                  {{ 'REPORTS.status' | translate }}: {{ option.label }}
                </option>
              </select>

              <select class="form-select filter-select-mobile" [formControl]="periodControl">
                <option *ngFor="let option of periodOptions" [value]="option.value">
                  {{ 'REPORTS.period' | translate }}: {{ option.label }}
                </option>
              </select>

              <select class="form-select filter-select-mobile" [formControl]="salesAgentIdControl">
                <option *ngFor="let option of salesAgentOptions()" [value]="option.value">
                  {{ 'REPORTS.sales-agent' | translate }}: {{ option.label }}
                </option>
              </select>
            </div>

            <!-- Action buttons -->
            <div class="mobile-action-btns d-flex gap-2 mb-3">
              <button
                class="btn btn-sm btn-outline-secondary px-3 py-2 d-flex align-items-center justify-content-center flex-grow-1"
                (click)="refreshInvoices()" [disabled]="loading()">
                <i class="pi me-2" [ngClass]="loading() ? 'pi-spinner pi-spin' : 'pi-refresh'"></i>
                <span class="d-none d-sm-inline">{{ 'COMMON.REFRESH' | translate }}</span>
              </button>

              <button
                class="btn btn-sm primary-bg-clr text-white px-3 py-2 d-flex align-items-center justify-content-center flex-grow-1"
                (click)="exportInvoices()" [disabled]="exportLoading() || invoicesData().length === 0">
                <i class="pi me-2" [ngClass]="exportLoading() ? 'pi-spinner pi-spin' : 'pi-download'"></i>
                <span class="d-none d-sm-inline">{{ 'COMMON.EXPORT' | translate }}</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div *ngIf="loading() || exportLoading()" class="mt-3">
          <div class="d-flex align-items-center gap-2">
            <p-progressSpinner [style]="{width: '20px', height: '20px'}" strokeWidth="4">
            </p-progressSpinner>
            <small class="text-muted">
              {{ exportLoading() ? ('REPORTS.exporting' | translate) : ('COMMON.LOADING' | translate) }}
            </small>
          </div>
        </div>
      </ng-template>

      <ng-template #header>
        <tr>
          <th class="text-center" style="width: 60px;">
            {{ 'REPORTS.invoice-number' | translate }}
          </th>
          <th>
            {{ 'REPORTS.customer-name' | translate }}
          </th>
          <th class="d-none d-md-table-cell">
            {{ 'REPORTS.invoice-date' | translate }}
          </th>
          <th class="d-none d-md-table-cell">
            {{ 'REPORTS.due-date' | translate }}
          </th>
          <th class="text-center">
            {{ 'REPORTS.total-amount' | translate }}
          </th>
          <th class="text-center">
            {{ 'REPORTS.due-amount' | translate }}
          </th>
          <th style="width: 100px;">
            {{ 'REPORTS.status' | translate }}
          </th>
        </tr>
      </ng-template>

      <ng-template #body let-invoice>
        <tr>
          <td class="text-center" [title]="invoice.invoiceNumber">
            <span class="fw-bold">{{ invoice.invoiceNumber }}</span>
          </td>
          <td>
            <span class="d-none d-md-inline">{{ invoice.customerName }}</span>
            <span class="d-md-none" [title]="invoice.customerName">
              {{ invoice.customerName | slice:0:12 }}{{ invoice.customerName.length > 12 ? '...' : '' }}
            </span>
          </td>
          <td class="d-none d-md-table-cell" [title]="formatDate(invoice.invoiceDate)">
            {{ formatDate(invoice.invoiceDate) }}
          </td>
          <td class="d-none d-md-table-cell" [title]="formatDate(invoice.dueDate)">
            {{ formatDate(invoice.dueDate) }}
          </td>
          <td class="text-center fw-bold">
            {{ formatCurrency(invoice.totalAmount) }}
          </td>
          <td class="text-center">
            <span [class.text-danger]="invoice.dueAmount > 0" [class.text-success]="invoice.dueAmount === 0">
              {{ formatCurrency(invoice.dueAmount) }}
            </span>
          </td>
          <td class="action-buttons">
            <p-tag [value]="getStatusLabel(invoice.status)" [severity]="getStatusSeverity(invoice.status)"
              [rounded]="true" styleClass="px-3 py-1">
            </p-tag>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="d-flex flex-column align-items-center">
              <i class="pi pi-info-circle text-muted mb-2" style="font-size: 2rem"></i>
              <p class="text-muted mb-0">{{ 'REPORTS.no-invoices-found' | translate }}</p>
              <small class="text-muted">{{ 'REPORTS.try-different-filters' | translate }}</small>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #paginatorleft>
        <small class="text-muted">
          {{ totalRecords() }} {{ 'COMMON.TOTAL_RECORDS' | translate }}
        </small>
      </ng-template>
    </p-table>
  </div>
</div>