<div class="container-fluid p-0 m-0 bg-gray-50 min-vh-100">
  <div class="order-details-container p-3 d-flex flex-column justify-content-start align-items-start gap-3">

    <!-- Top Header -->
    <header
      class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 w-100 gap-3">
      <div class="d-flex align-items-center gap-3">
        <!-- Back Button -->
        <button
          class="back-btn btn btn-sm p-2 bg-white border border-gray-200 rounded-lg d-flex justify-content-center align-items-center"
          (click)="goBack()">
          <i class="pi pi-chevron-left text-gray-600"></i>
        </button>
        <h1 class="mb-0 fs-4 fw-bold text-gray-900">
          {{ 'orders-crm.order-details.title' | translate }}
        </h1>
      </div>
    </header>

    <!-- Order ID & Actions Bar -->
    <div class="bg-white rounded-3 p-4 shadow-sm border border-gray-100 mb-4 w-100">
      <div class="d-flex flex-column flex-xl-row justify-content-between align-items-start align-items-xl-center gap-4">

        <!-- Left: ID, Date, Status -->
        <div class="d-flex flex-column gap-2">
          <div class="d-flex align-items-center gap-3">
            <span class="fs-5 fw-bold text-gray-900">
              {{ 'orders-crm.order-details.order-id' | translate }}<span class="fs-6 text-muted"> #{{ order()?.id ||
                'N/A' }}</span>
            </span>
          </div>
          <div class="mt-2">
            <span [class]="getStatusClass(order()?.status || '')"
              class="badge px-3 py-2 rounded-pill text-xs fw-medium">
              {{ getStatusTranslation(order()?.status || '') }}
            </span>
          </div>
        </div>

        <!-- Right: Actions -->
        <div class="d-flex flex-wrap align-items-center gap-3 w-100 w-xl-auto">

          <!-- Status Dropdown -->
          <div class="position-relative" style="min-width: 160px;">
            <select
              class="form-select bg-gray-50 border border-gray-200 text-gray-600 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 py-2 pe-4"
              (change)="onStatusChange($event)">
              <option selected disabled>
                {{ 'orders-crm.order-details.change-status' | translate }}
              </option>
              <option value="Pending">{{ 'orders-crm.order-details.pending' | translate }}</option>
              <option value="Processing">{{ 'orders-crm.order-details.processing' | translate }}</option>
              <option value="Completed">{{ 'orders-crm.order-details.completed' | translate }}</option>
              <option value="Cancelled">{{ 'orders-crm.order-details.cancelled' | translate }}</option>
            </select>
          </div>

          <button
            class="btn btn-sm text-gray-600 bg-gray-50 border border-gray-200 rounded-lg hover-bg-gray-100 px-4 py-2"
            (click)="saveOrder()" [disabled]="saving()">
            @if (saving()) {
            <span class="spinner-border spinner-border-sm me-2"></span>
            }
            {{ 'orders-crm.order-details.save' | translate }}
          </button>

          <button
            class="btn btn-sm text-blue-600 bg-white border border-blue-100 rounded-lg hover-bg-blue-50 px-4 py-2 d-flex align-items-center gap-2"
            (click)="downloadInvoice()" [disabled]="loading()">
            @if (loading()) {
            <span class="spinner-border spinner-border-sm"></span>
            } @else {
            <i class="pi pi-download"></i>
            }
            {{ 'orders-crm.order-details.download' | translate }}
          </button>

          <button class="btn btn-sm p-2 text-gray-600 bg-white border border-gray-200 rounded-lg hover-bg-gray-50"
            (click)="printOrder()">
            <i class="pi pi-print"></i>
            <span class="d-none d-sm-inline ms-1">{{ 'orders-crm.order-details.print' | translate }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    @if (loading()) {
    <div class="w-100 d-flex justify-content-center align-items-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
      </div>
      <span class="ms-3 text-gray-600">{{ 'COMMON.LOADING' | translate }}</span>
    </div>
    }

    <!-- Error State -->
    @if (error()) {
    <div class="w-100 alert alert-danger">
      {{ error() }}
    </div>
    }

    <!-- Order Details Content -->
    @if (order() && !loading()) {
    <div class="row g-4 mb-4">

      <!-- Customer Card -->
      <div class="col-12 col-md-6 col-xl-4">
        <div class="bg-transparent p-0">
          <div class="d-flex align-items-start gap-3">
            <div class="rounded-circle bg-gray-100 d-flex align-items-center justify-content-center flex-shrink-0"
              style="width: 48px; height: 48px;">
              <i class="pi pi-user text-gray-600"></i>
            </div>
            <div>
              <h3 class="fw-bold text-gray-900 fs-6 mb-2">
                {{ 'orders-crm.order-details.customer-info' | translate }}
              </h3>
              <div class="space-y-1">
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 60px;">
                    {{ 'orders-crm.order-details.name' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ order()?.customerName }}</span>
                </p>
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 60px;">
                    {{ 'orders-crm.order-details.email' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ order()?.customerEmail }}</span>
                </p>
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 60px;">
                    {{ 'orders-crm.order-details.phone' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ order()?.customerPhone }}</span>
                </p>
                @if (order()?.buyerName) {
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 60px;">
                    {{ 'orders-crm.order-details.buyer-name' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ order()?.buyerName }}</span>
                </p>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Info Card -->
      <div class="col-12 col-md-6 col-xl-4">
        <div class="bg-transparent p-0">
          <div class="d-flex align-items-start gap-3">
            <div class="rounded-circle bg-gray-100 d-flex align-items-center justify-content-center flex-shrink-0"
              style="width: 48px; height: 48px;">
              <i class="pi pi-shopping-cart text-gray-600"></i>
            </div>
            <div>
              <h3 class="fw-bold text-gray-900 fs-6 mb-2">
                {{ 'orders-crm.order-details.payment-info' | translate }}
              </h3>
              <div class="space-y-1">
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 80px;">
                    {{ 'orders-crm.order-details.total-amount' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">$ {{ order()?.amount | number: '1.2-2' }}</span>
                </p>
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 80px;">
                    {{ 'orders-crm.order-details.payment-method' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ getPaymentMethodTranslation(order()?.paymentMethod || '')
                    }}</span>
                </p>
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 80px;">
                    {{ 'orders-crm.order-details.payment-status' | translate }}:
                  </span>
                  <span [class]="getPaymentStatusClass(order()?.paymentStatus || '')" class="badge">
                    {{ getPaymentStatusTranslation(order()?.paymentStatus || '') }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery Card -->
      <div class="col-12 col-md-6 col-xl-4">
        <div class="bg-transparent p-0">
          <div class="d-flex align-items-start gap-3">
            <div class="rounded-circle bg-gray-100 d-flex align-items-center justify-content-center flex-shrink-0"
              style="width: 48px; height: 48px;">
              <i class="pi pi-truck text-gray-600"></i>
            </div>
            <div>
              <h3 class="fw-bold text-gray-900 fs-6 mb-2">
                {{ 'orders-crm.order-details.shipping-info' | translate }}
              </h3>
              <div class="space-y-1">
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 70px;">
                    {{ 'orders-crm.order-details.address' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ order()?.address }}</span>
                </p>
                <div class="d-flex gap-3 mb-2">
                  <p class="text-sm mb-0">
                    <span class="text-gray-400 d-inline-block" style="width: 70px;">
                      {{ 'orders-crm.order-details.state' | translate }}:
                    </span>
                    <span class="fw-medium text-gray-700">{{ order()?.state }}</span>
                  </p>
                  <p class="text-sm mb-0">
                    <span class="text-gray-400 d-inline-block" style="width: 70px;">
                      {{ 'orders-crm.order-details.country' | translate }}:
                    </span>
                    <span class="fw-medium text-gray-700">{{ order()?.country }}</span>
                  </p>
                </div>
                <p class="text-sm mb-2">
                  <span class="text-gray-400 d-inline-block" style="width: 70px;">
                    {{ 'orders-crm.order-details.zip-code' | translate }}:
                  </span>
                  <span class="fw-medium text-gray-700">{{ order()?.zipCode }}</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes Card (Spans 2 columns on large screens) -->
      <div class="col-12 col-xl-8">
        <div class="bg-transparent p-0 mt-3">
          <div class="d-flex align-items-start gap-3 w-100">
            <div class="rounded-circle bg-gray-100 d-flex align-items-center justify-content-center flex-shrink-0"
              style="width: 48px; height: 48px;">
              <i class="pi pi-pencil text-gray-600"></i>
            </div>
            <div class="w-100">
              <h3 class="fw-bold text-gray-900 fs-6 mb-2">{{ 'orders-crm.order-details.notes' | translate }}</h3>
              <div class="position-relative">
                <textarea [(ngModel)]="currentNote"
                  class="form-control w-100 p-3 text-sm border border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 min-h-20 bg-white resize-none"
                  [placeholder]="'orders-crm.order-details.type-note-placeholder' | translate" rows="3"></textarea>
                <div class="d-flex justify-content-end mt-2">
                  <button
                    class="btn btn-sm px-3 py-1 text-xs fw-semibold text-blue-600 bg-white border border-gray-200 rounded hover-bg-gray-50"
                    (click)="saveNote()">
                    {{ 'COMMON.SAVE' | translate }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-3 p-4 shadow-sm border border-gray-100">
      <h3 class="fw-bold text-gray-900 fs-5 mb-4">
        {{ 'orders-crm.order-details.order-items' | translate }}
      </h3>

      <div class="orders-table overflow-x-auto overflow-y-auto w-100">
        <div class="table-responsive w-100">
          <table class="table table-hover align-middle mb-0 w-100">
            <thead class="table-light">
              <tr>
                <th scope="col" style="width: 40px;" class="ps-3"></th>
                <th scope="col" class="text-start">{{ 'orders-crm.order-details.item-name' | translate }}</th>
                <th scope="col" class="text-center">{{ 'orders-crm.order-details.price' | translate }}</th>
                <th scope="col" class="text-center">{{ 'orders-crm.order-details.quantity' | translate }}</th>
                <th scope="col" class="text-end pe-3">{{ 'orders-crm.order-details.total' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              @for (item of order()?.orderItems; track item.id) {
              <tr>
                <td class="ps-3">
                  <input type="checkbox" class="form-check-input" [checked]="isItemSelected(item.id)"
                    (change)="toggleItemSelection(item.id)">
                </td>
                <td class="text-start">
                  <div class="d-flex align-items-center gap-3">
                    <div
                      class="bg-primary bg-opacity-10 rounded-2 d-flex align-items-center justify-content-center p-2">
                      <i class="pi pi-box text-primary fs-6"></i>
                    </div>
                    <div>
                      <div class="fw-medium text-gray-800">{{ item.name }}</div>
                      <small class="text-muted">{{ 'orders-crm.order-details.id' | translate }}: {{ item.id | slice: -8
                        }}</small>
                    </div>
                  </div>
                </td>
                <td class="text-center">
                  <span class="fw-medium text-gray-800">${{ item.price | number:'1.2-2' }}</span>
                </td>
                <td class="text-center">
                  <div class="d-inline-flex align-items-center gap-2">
                    <span class="fw-medium" style="min-width: 24px;">{{ item.quantity }}</span>
                  </div>
                </td>
                <td class="text-end pe-3">
                  <span class="fw-bold text-gray-900">${{ item.total | number:'1.2-2' }}</span>
                  @if (item.quantity > 1) {
                  <div class="text-muted small">${{ item.price | number:'1.2-2' }} Ã— {{ item.quantity }}</div>
                  }
                </td>
              </tr>
              }

              <!-- Summary Footer -->
              <tr class="table-active">
                <td colspan="3" class="pt-3 ps-3 border-top">
                  <div class="d-flex align-items-center gap-2">
                    <i class="pi pi-chart-bar text-primary"></i>
                    <span class="fw-medium text-gray-700">{{ 'orders-crm.order-details.summary' | translate }}</span>
                    @if (selectedItems().length > 0) {
                    <span class="badge bg-primary rounded-pill ms-2">{{ selectedItems().length }} {{
                      'orders-crm.order-details.selected' | translate }}</span>
                    }
                  </div>
                </td>
                <td class="pt-3 text-center border-top">
                  <div class="fw-bold text-gray-800">{{ itemsTotalQuantity() }}</div>
                  <small class="text-muted">{{ 'orders-crm.order-details.items' | translate }}</small>
                </td>
                <td class="pt-3 pe-3 text-end border-top">
                  <div class="fw-bold text-primary fs-5">${{ itemsTotalPrice() | number:'1.2-2' }}</div>
                  <small class="text-muted">{{ 'orders-crm.order-details.order-total' | translate }}</small>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Footer with totals -->
      <div
        class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mt-4 pt-3 border-top">
        <div class="text-muted small">
          <i class="pi pi-info-circle me-1"></i>
          {{ 'orders-crm.order-details.showing' | translate: { count: order()?.orderItems?.length || 0, selected:
          selectedItems().length } }}
        </div>
        <div class="d-flex flex-wrap gap-4">
          <div class="text-end">
            <div class="text-muted small">{{ 'orders-crm.order-details.subtotal' | translate }}</div>
            <div class="fw-medium">${{ itemsTotalPrice() | number:'1.2-2' }}</div>
          </div>
          <!-- Removed tax section -->
          <div class="text-end">
            <div class="text-gray-700 fw-semibold">{{ 'orders-crm.order-details.grand-total' | translate }}</div>
            <div class="fw-bold text-primary fs-5">${{ itemsTotalPrice() | number:'1.2-2' }}</div>
          </div>
        </div>
      </div>
    </div>
    }
  </div>
</div>