<section class="page">
  <header class="page__header">
    <h1 class="page__title">{{ 'operations.operation-files.title' | translate }}</h1>
  </header>

  @if (loading()) {
  <div class="state state--loading">
    {{ 'operations.operation-files.loading-details' | translate }}
  </div>
  } @else if (error()) {
  <div class="state state--error">{{ error() }}</div>
  } @else if (details()) {
  <div class="card">
    <div class="card__header">
      <h2 class="card__title">{{ 'operations.operation-files.user-info' | translate }}</h2>
    </div>
    <div class="card__body">
      @if (objectKeys(parsedUserInfo()).length === 0) {
      <p class="muted">{{ 'operations.operation-files.no-user-info' | translate }}</p>
      } @else {
      <dl class="info-grid">
        @for (key of objectKeys(parsedUserInfo()); track key) {
        <div class="info-grid__row">
          <dt class="info-grid__term">{{ key }}</dt>
          <dd class="info-grid__value">{{ parsedUserInfo()[key] }}</dd>
        </div>
        }
      </dl>
      }
    </div>
  </div>

  <div class="card">
    <div class="card__header">
      <h2 class="card__title">{{ 'operations.operation-files.service-files' | translate }}</h2>
    </div>
    <div class="card__body">
      @if (serviceFiles().length === 0) {
      <p class="muted">{{ 'operations.operation-files.no-service-files' | translate }}</p>
      } @else {
      <div class="file-list">
        @for (file of serviceFiles(); track file.id) {
        <article class="file-card">
          <div class="file-card__header">
            <div>
              <p class="file-card__title">
                {{ file.serviceFileName }}
                @if (hasAddedRequest(file.serviceFileId)) {
                <span class="badge badge-success ms-2">
                  <i class="pi pi-check"></i>
                  {{ 'operations.operation-files.request-added' | translate }}
                </span>
                }
              </p>
              <p class="file-card__meta">
                {{ 'operations.operation-files.created' | translate }}:
                {{ file.createdDate | date : 'dd/MM/yyyy' }}
              </p>
            </div>
            @if (isUnderReview()) {
            <div class="d-flex gap-2">
              @if (hasAddedRequest(file.serviceFileId)) {
              <button
                class="btn btn-outline-danger d-flex justify-content-center align-items-center gap-2"
                type="button"
                (click)="removeRequest(file.serviceFileId)"
              >
                <i class="pi pi-trash"></i>
                {{ 'operations.operation-files.remove-request' | translate }}
              </button>
              } @else {
              <button
                class="btn primary-bg-clr text-white d-flex justify-content-center align-items-center gap-2"
                type="button"
                (click)="toggleRequest(file.serviceFileId)"
              >
                <i class="pi pi-pencil"></i>
                {{ 'operations.operation-files.request-edit' | translate }}
              </button>
              }
            </div>
            }
          </div>

          @if (file.note) {
          <p class="file-card__note">
            {{ 'operations.operation-files.note' | translate }}: {{ file.note }}
          </p>
          } @if (file.files.length) {
          <div class="file-card__files">
            @for (image of file.files; track image.guidName) {
            <a class="file-link" [href]="image.path" target="_blank" rel="noopener noreferrer">
              {{ image.name }}
            </a>
            }
          </div>
          } @if (activeEditId() === file.serviceFileId && !hasAddedRequest(file.serviceFileId)) {
          <div class="edit-form">
            <label class="edit-form__label" for="comment-{{ file.serviceFileId }}">
              {{ 'operations.operation-files.comment' | translate }}
            </label>
            <textarea
              class="edit-form__input"
              id="comment-{{ file.serviceFileId }}"
              rows="3"
              [value]="commentValue(file.serviceFileId)"
              (input)="onCommentChange(file.serviceFileId, $any($event.target).value)"
              [placeholder]="'operations.operation-files.comment-placeholder' | translate"
            ></textarea>
            <div class="edit-form__actions">
              <button
                class="btn primary-bg-clr text-white"
                type="button"
                [disabled]="!commentValue(file.serviceFileId).trim()"
                (click)="addRequest(file.serviceFileId)"
              >
                {{ 'operations.operation-files.add-request' | translate }}
              </button>
              <button
                class="btn btn-ghost"
                type="button"
                (click)="toggleRequest(file.serviceFileId)"
              >
                {{ 'operations.operation-files.cancel' | translate }}
              </button>
            </div>
          </div>
          }
        </article>
        }
      </div>

      @if (isUnderReview()) { @if (pendingRequestsCount() > 0) {
      <div class="submit-all-container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <p class="text-muted mb-0">
            {{
              'operations.operation-files.pending-requests-count'
                | translate : { count: pendingRequestsCount() }
            }}
          </p>
        </div>
        <button
          class="btn btn-lg primary-bg-clr text-white w-100 d-flex justify-content-center align-items-center gap-2"
          type="button"
          [disabled]="submittingBatch()"
          (click)="submitAllRequests()"
        >
          @if (submittingBatch()) {
          <i class="pi pi-spin pi-spinner"></i>
          {{ 'operations.operation-files.submitting-requests' | translate }}
          } @else {
          <i class="pi pi-send"></i>
          {{ 'operations.operation-files.submit-all-requests' | translate }}
          ({{ pendingRequestsCount() }}) }
        </button>
      </div>
      } @else {
      <div class="submit-all-container mt-4">
        <div class="d-flex gap-3">
          <button
            class="btn btn-lg btn-success text-white flex-fill d-flex justify-content-center align-items-center gap-2"
            type="button"
            [disabled]="acceptingSubmission()"
            (click)="acceptSubmission()"
          >
            @if (acceptingSubmission()) {
            <i class="pi pi-spin pi-spinner"></i>
            {{ 'operations.operation-files.accepting-submission' | translate }}
            } @else {
            <i class="pi pi-check-circle"></i>
            {{ 'operations.operation-files.accept-submission' | translate }}
            }
          </button>
          <button
            class="btn btn-lg btn-danger text-white flex-fill d-flex justify-content-center align-items-center gap-2"
            type="button"
            [disabled]="rejectingSubmission()"
            (click)="toggleRejectForm()"
          >
            <i class="pi pi-times-circle"></i>
            {{ 'operations.operation-files.reject-submission' | translate }}
          </button>
        </div>

        @if (showRejectForm()) {
        <div class="reject-form mt-3">
          <label class="form-label" for="reject-comment">
            {{ 'operations.operation-files.rejection-reason' | translate }}
          </label>
          <textarea
            class="form-control"
            id="reject-comment"
            rows="3"
            [value]="rejectComment()"
            (input)="rejectComment.set($any($event.target).value)"
            [placeholder]="'operations.operation-files.rejection-reason-placeholder' | translate"
          ></textarea>
          <div class="d-flex gap-2 mt-3">
            <button
              class="btn btn-danger text-white flex-fill"
              type="button"
              [disabled]="!rejectComment().trim() || rejectingSubmission()"
              (click)="submitRejection()"
            >
              @if (rejectingSubmission()) {
              <i class="pi pi-spin pi-spinner"></i>
              {{ 'operations.operation-files.rejecting-submission' | translate }}
              } @else {
              {{ 'operations.operation-files.submit-rejection' | translate }}
              }
            </button>
            <button
              class="btn btn-secondary flex-fill"
              type="button"
              [disabled]="rejectingSubmission()"
              (click)="toggleRejectForm()"
            >
              {{ 'operations.operation-files.cancel' | translate }}
            </button>
          </div>
        </div>
        }
      </div>
      } } }
    </div>
  </div>
  }
</section>
